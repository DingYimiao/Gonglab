# Gonglab
#Code for Drosophila Larvae Generate Force to Counteract External Mechanical Pressures


Forcecal: Drosophila Larval Force Measurement System

(MATLAB App for Biomechanical Behavior Analysis)

(V1.0)

1 System Overview	1
2 Hardware Configuration：	1
3 Core Functional Modules：	1
3.1 Data Acquisition Protocol	1
3.2 Training Paradigm	1
3.3 Data Processing Tools	2
4 Key Algorithms:	2
4.1 Peristaltic Wave Detection	2
4.2 Video Analysis Pipeline	2
4.3 Dynamic Pressure Control	2
5 Output Data Structure:	2
6 Operational Workflow:	3
7 Troubleshooting Guide:	3
                      
 1 System Overview
Forcecal is a MATLAB App Designer-based platform for quantifying Drosophila larval biomechanical responses under controlled mechanical pressures. The system integrates:
Real-time force monitoring (5,000 Hz sampling via RDF-DP01 sensor)
Precision pressure modulation (Z-axis displacement platform, ±10 μm resolution)
Synchronized behavioral recording (120 fps video with locomotion annotation)
Automated data processing (force dynamics, peristaltic wave analysis, video tracking)
This system enables lab-scale investigation of larval counteraction behaviors against abiotic pressures.
2 Hardware Configuration：
 
3 Core Functional Modules：
3.1 Data Acquisition Protocol
Setup:
Position larva on aluminum platform (head toward narrow cleft).
Set parameters: Aim force(mN): Baseline compression (default=25mN);
Saving path: Data directory (e.g., D:\Force_larva\Data\CS\Temp); 
Sample index: Auto-incremented specimen ID.
Click Start to: Initiate 5-second pressure ramp; Begin force-video synchronization.
Behavioral Annotation:
Press Q → Mark forward peristalsis (FWD)
Press W → Mark backward peristalsis (BWD)
Termination:
Click Stop → Saves time_force_locomotiondata.mat and recorded_video.avi
3.2 Training Paradigm
Button	Function
TrainStart	Initiate training protocol with Train Aim (mN) pressure
Training	↓20mN pressure after FWD (reward counteraction)
DecTraining	↑20mN pressure after FWD (punish counteraction)
TrainControl	Maintain dynamic feedback loop
3.3 Data Processing Tools
Button	Function
Data deal	Batch-processes MAT files:
- Calculates 15+ kinematic metrics
- Exports statistics.xlsx
Video deal	Analyzes video:
- Tracks larval centroid/head/tail
- Computes speed/angle dynamics
Result show	Visualizes processed data:
- Force vs. locomotion traces
- Peak detection
4 Key Algorithms:
4.1 Peristaltic Wave Detection
% Identify forward/backward waves (Data deal button)
forward_idx = find(locomotion(2:end)==1 & locomotion(1:end-1)~=1)+1;
backward_idx = find(locomotion(2:end)==-1 & locomotion(1:end-1)~=-1)+1;
% Calculate force deltas per wave
fwdforcechange = force(fwd_end_idx) - force(fwd_start_idx);
4.2 Video Analysis Pipeline
% Frame processing (Video deal button)
binaryFrame = imbinarize(rgb2gray(frame)); 
centroid = regionprops(binaryFrame,'Centroid'); 
velocity = norm(Δcentroid)/(32.0624 pixels/mm * Δt);
4.3 Dynamic Pressure Control
% Adaptive pressure adjustment (startMeasurement function)
if locomotion == 1 && app.isCondition5Met % FWD during training
    connect2motor(app.m,"V_ABS 0 50"); % ↓20mN reward
end
5 Output Data Structure:
Primary Outputs:
S{index}/time_force_locomotiondata.mat:
timeData: [1×N double]       % Timestamps (sec)
forceData: [1×N double]     % Force values (mN)
locomotionData: [1×N double] % [-1,0,1] for BWD/STATIC/FWD
statistics.xlsx (generated by Data deal):
Metric	Description
forward_frequency		FWD waves per second
maxforceadd	Max force increase per wave
angle_variation	Head-tail angle dynamics
6 Operational Workflow:
Initialization:
Confirm COM port connections
Set Saving path and Sample index
Verify camera focus on platform
Acquisition:
Click Start → Annotate behaviors with Q/W keys
Monitor real-time force plot on UI axes
Post-processing:
Use Data deal for batch metric extraction
Run Video deal for trajectory analysis
Validation:
Check Output console for system messages
Export figures via Result show
7 Troubleshooting Guide:
Symptom	Resolution
No force signal	
Check sensor power → Validate COM4 baud rate
Motor unresponsive	
Execute Reset → Confirm V_ACC_DEC 500 800 parameters
Video sync failure
Ensure 65% RH environment → Reinitialize camera
Data saving error	
Disable write protection → Manually create subfolders

 

Validation Metrics:
Force accuracy: ±0.1 mN (vs. calibrated weights)
Temporal alignment: <0.1s video-force sync error
Processing speed: 2 min trials processed in <1s (i7-12700H)

System Requirements:
MATLAB R2024a+
Image Processing Toolbox
Instrument Control Toolbox
Signal Processing Toolbox
8GB RAM minimum
Reference: J. Exp. Biol. Drosophila Larvae Generate Force to Counteract External Mechanical Pressures
Code Repository: https://github.com/DingYimiao/Gonglab#
Technical Contact: dingyimiao@zju.edu.cn
